<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ikeda Generator v3 (Intensity)</title>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: monospace; user-select: none; }
        
        /* -- UI Elements -- */
        #overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; border: 1px solid white; padding: 20px;
            cursor: pointer; z-index: 20; text-align: center;
            background: rgba(0,0,0,0.8);
        }
        
        #controls {
            position: absolute; bottom: 30px; left: 30px; right: 30px;
            display: flex; justify-content: space-between; align-items: center;
            color: white; z-index: 10; display: none; /* Hidden until start */
        }

        /* Minimal Slider Styling */
        input[type=range] {
            -webkit-appearance: none; width: 300px; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 10px; background: #fff;
            cursor: pointer; margin-top: -8px; border: 1px solid #000;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; cursor: pointer; background: #555;
        }
        input[type=range]:focus { outline: none; }
        
        #muteBtn {
            cursor: pointer; padding: 5px 10px; border: 1px solid white;
        }
        #muteBtn:hover { background: #fff; color: #000; }

        .label { font-size: 12px; margin-bottom: 5px; display: block;}
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
</head>
<body>

<div id="overlay">CLICK TO INITIALIZE SYSTEM</div>

<div id="controls">
    <div>
        <span class="label">INTENSITY_REQ <span id="valDisplay">50</span>%</span>
        <input type="range" id="intensitySlider" min="0" max="100" value="50">
    </div>
    <div id="muteBtn">MUTE AUDIO</div>
</div>

<script>
    let isPlaying = false;
    let currentStep = 0;
    
    // -- Global State --
    let intensity = 0.5; // 0.0 to 1.0

    // -- Visual State --
    let bgCol = 0;
    let barcodeActive = false;
    let barcodeSeed = 0;
    let gridOpacity = 0;

    // -- AUDIO SETUP --
    
    // 1. Sub Bass
    const subSynth = new Tone.MembraneSynth({
        pitchDecay: 0.05, octaves: 2, oscillator: { type: "sine" },
        envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.1 }
    }).toDestination();

    // 2. Glitch (Panning)
    const panner = new Tone.Panner(0).toDestination();
    const noiseSynth = new Tone.NoiseSynth({
        noise: { type: "white" },
        envelope: { attack: 0.001, decay: 0.05, sustain: 0 }
    }).connect(panner);

    // 3. Data Drone
    const
