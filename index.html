<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ikeda/Byetone Generator</title>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; }
        #overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-family: monospace; text-align: center; cursor: pointer;
            border: 1px solid white; padding: 20px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
</head>
<body>

<div id="overlay">CLICK TO START SYSTEM</div>

<script>
    let isPlaying = false;
    let currentStep = 0;
    
    // Visual State Variables
    let bgCol = 0;
    let drawLine = false;
    let barHeight = 0;
    let gridOpacity = 0;

    // --- AUDIO SETUP ---
    // 1. Sub Bass (Pure Sine)
    const subSynth = new Tone.MembraneSynth({
        pitchDecay: 0.05,
        octaves: 2,
        oscillator: { type: "sine" },
        envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.1 }
    }).toDestination();

    // 2. Noise/Click (Glitch)
    const noiseSynth = new Tone.NoiseSynth({
        noise: { type: "white" },
        envelope: { attack: 0.001, decay: 0.05, sustain: 0 }
    }).toDestination();

    // 3. High Frequency Sine (Data sound)
    const dataSynth = new Tone.Oscillator({
        type: "sine",
        frequency: 8000
    }).toDestination().start();
    const dataAmp = new Tone.Volume(-60).toDestination(); // Start silent
    dataSynth.connect(dataAmp);


    // --- SEQUENCER ---
    // We use Tone.Loop for precise timing
    const loop = new Tone.Loop((time) => {
        // 16th note step counter
        currentStep = (currentStep + 1) % 16;
        
        // Randomize probabilities for a generative feel
        
        // KICK (Sub) - Steady pulse on 1, 5, 9, 13 (4/4 feel) or random
        if (currentStep % 4 === 0 || Math.random() > 0.9) {
            subSynth.triggerAttackRelease("C1", "8n", time);
            // VISUAL TRIGGER: Invert Background (Strobe)
            Tone.Draw.schedule(() => {
                bgCol = bgCol === 0 ? 255 : 0; 
            }, time);
        } else {
             // Reset strobe
             Tone.Draw.schedule(() => {
                bgCol = 0; 
            }, time);
        }

        // CLICK (High Noise) - Random glitch patterns
        if (Math.random() > 0.7) {
            noiseSynth.triggerAttackRelease("32n", time);
            // VISUAL TRIGGER: Random vertical bar
            Tone.Draw.schedule(() => {
                barHeight = Math.random() * window.innerHeight;
                drawLine = true;
            }, time);
        } else {
            Tone.Draw.schedule(() => {
                drawLine = false;
            }, time);
        }

        // DATA DRONE - Short blips
        if (Math.random() > 0.8) {
            dataSynth.frequency.value = [4000, 8000, 12000][Math.floor(Math.random()*3)];
            dataAmp.volume.rampTo(-10, 0.01, time);
            dataAmp.volume.rampTo(-60, 0.1, time + 0.05);
            
            // VISUAL TRIGGER: Flash Grid
            Tone.Draw.schedule(() => {
                gridOpacity = 255;
            }, time);
        }

    }, "16n").start(0);

    Tone.Transport.bpm.value = 140; // Fast Tempo for Ryoji style

    // --- P5.JS VISUAL SETUP ---
    function setup() {
        createCanvas(windowWidth, windowHeight);
        background(0);
        rectMode(CENTER);
    }

    function draw() {
        // 1. Background Strobe
        background(bgCol);

        // Calculate contrast color (opposite of background)
        let contrast = bgCol === 0 ? 255 : 0;
        fill(contrast);
        stroke(contrast);

        // 2. Glitch Bar (Correlates to Noise Clicks)
        if (drawLine) {
            let x = random(width);
            let w = random(2, 50);
            noStroke();
            rect(x, height/2, w, barHeight);
        }

        // 3. Data Grid (Correlates to High Freq Blips)
        if (gridOpacity > 0) {
            stroke(contrast, gridOpacity);
            noFill();
            let gridSize = 50;
            for (let i = 0; i < width; i+=gridSize) {
                line(i, 0, i, height);
            }
            gridOpacity -= 20; // Fade out quickly
        }
        
        // 4. Center Line (Scanning aesthetic)
        stroke(contrast);
        line(0, height/2, width, height/2);
        
        // Text info
        noStroke();
        fill(contrast);
        textSize(12);
        text("RPM: 140 | STEP: " + currentStep, 20, 30);
    }

    function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
    }

    // --- INTERACTION ---
    document.getElementById('overlay').addEventListener('click', async () => {
        await Tone.start();
        if (!isPlaying) {
            Tone.Transport.start();
            document.getElementById('overlay').style.display = 'none';
            isPlaying = true;
        }
    });

</script>
</body>
</html>
