<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Ikeda Generator v3.2 (Low Pitch)</title>
    <style>
        body { margin: 0; padding: 0; background: #000; overflow: hidden; font-family: monospace; user-select: none; }
        
        /* -- UI Elements -- */
        #overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; border: 1px solid white; padding: 20px;
            cursor: pointer; z-index: 20; text-align: center;
            background: rgba(0,0,0,0.8);
            transition: opacity 0.5s;
        }
        
        #controls {
            position: absolute; bottom: 30px; left: 30px; right: 30px;
            display: flex; justify-content: space-between; align-items: center;
            color: white; z-index: 10; display: none; /* Hidden until start */
        }

        /* Minimal Slider Styling */
        input[type=range] {
            -webkit-appearance: none; width: 300px; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 10px; background: #fff;
            cursor: pointer; margin-top: -8px; border: 1px solid #000;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 2px; cursor: pointer; background: #555;
        }
        input[type=range]:focus { outline: none; }
        
        #muteBtn {
            cursor: pointer; padding: 5px 10px; border: 1px solid white;
        }
        #muteBtn:hover { background: #fff; color: #000; }

        .label { font-size: 12px; margin-bottom: 5px; display: block;}
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
</head>
<body>

<div id="overlay">CLICK TO INITIALIZE SYSTEM</div>

<div id="controls">
    <div>
        <span class="label">INTENSITY_REQ <span id="valDisplay">50</span>%</span>
        <input type="range" id="intensitySlider" min="0" max="100" value="50">
    </div>
    <div id="muteBtn">MUTE AUDIO</div>
</div>

<script>
    let isPlaying = false;
    let currentStep = 0;
    
    // -- Global State --
    let intensity = 0.5;

    // -- Visual State --
    let bgCol = 0;
    let barcodeActive = false;
    let barcodeSeed = 0;
    let gridOpacity = 0;

    // -- AUDIO VARIABLES (Declared but not built yet) --
    let subSynth, noiseSynth, panner, dataSynth, dataAmp, loop;

    // -- P5 VISUALS --
    function setup() {
        createCanvas(windowWidth, windowHeight);
        background(0);
        rectMode(CORNER);
    }

    function draw() {
        // Always draw background to clear previous frame
        background(bgCol);
        let contrast = bgCol === 0 ? 255 : 0;
        
        // 1. Barcode
        if (barcodeActive) {
            stroke(contrast);
            fill(contrast);
            randomSeed(barcodeSeed);
            let x = 0;
            let density = map(intensity, 0, 1, 10, 2); 
            while(x < width) {
                let w = random(1, 20);
                if (random() > 0.5) rect(x, 0, w, height);
                x += w + density;
            }
        }

        // 2. Grid
        if (gridOpacity > 0) {
            stroke(contrast, gridOpacity);
            let gridSize = map(intensity, 0, 1, 100, 20);
            for (let y = 0; y < height; y+=gridSize) {
                line(0, y, width, y);
            }
            gridOpacity -= 15;
        }

        // 3. Crosshair
        stroke(contrast);
        line(width/2 - 20, height/2, width/2 + 20, height/2);
        line(width/2, height/2 - 20, width/2, height/2 + 20);
    }

    function windowResized() { resizeCanvas(windowWidth, windowHeight); }

    // -- INITIALIZE AUDIO (Runs only on click) --
    async function initAudio() {
        await Tone.start();
        console.log("Audio Context Started");

        // 1. Sub Bass
        subSynth = new Tone.MembraneSynth({
            pitchDecay: 0.05, octaves: 2, oscillator: { type: "sine" },
            envelope: { attack: 0.001, decay: 0.2, sustain: 0, release: 0.1 }
        }).toDestination();

        // 2. Glitch (Panning)
        panner = new Tone.Panner(0).toDestination();
        noiseSynth = new Tone.NoiseSynth({
            noise: { type: "white" },
            envelope: { attack: 0.001, decay: 0.05, sustain: 0 }
        }).connect(panner);

        // 3. Data Drone (LOWERED PITCH)
        // Starting frequency is now 800Hz (Mid-range beep)
        dataSynth = new Tone.Oscillator({ type: "sine", frequency: 800 }).toDestination().start();
        dataAmp = new Tone.Volume(-60).toDestination();
        dataSynth.connect(dataAmp);

        // 4. Sequencer Loop
        loop = new Tone.Loop((time) => {
            currentStep = (currentStep + 1) % 16;
            
            let kickThresh = 0.9 - (intensity * 0.4); 
            let clickThresh = 0.9 - (intensity * 0.8);
            let droneThresh = 0.95 - (intensity * 0.6);

            // Kick
            if (currentStep % 4 === 0 || Math.random() > kickThresh) {
                subSynth.triggerAttackRelease("C1", "8n", time);
                Tone.Draw.schedule(() => { bgCol = 255; }, time);
            } else {
                Tone.Draw.schedule(() => { bgCol = 0; }, time);
            }

            // Click
            if (Math.random() > clickThresh) {
                let panVal = Math.random() > 0.5 ? -1 : 1;
                panner.pan.setValueAtTime(panVal, time);
                noiseSynth.triggerAttackRelease("32n", time);

                Tone.Draw.schedule(() => {
                    barcodeActive = true;
                    barcodeSeed = Math.random() * 1000;
                }, time);
            } else {
                Tone.Draw.schedule(() => { barcodeActive = false; }, time);
            }

            // Drone
            if (Math.random() > droneThresh) {
                // --- DRASTICALLY LOWERED FREQUENCIES ---
                // Range: 800Hz to 3000Hz (Comfortable Beeps)
                let freqArr = [800, 1200]; 
                if(intensity > 0.5) freqArr.push(2000, 3000); 
                
                let freq = freqArr[Math.floor(Math.random()*freqArr.length)];
                dataSynth.frequency.setValueAtTime(freq, time);
                
                dataAmp.volume.rampTo(-12, 0.01, time);
                dataAmp.volume.rampTo(-60, 0.1, time + 0.1);
                
                Tone.Draw.schedule(() => { gridOpacity = 255; }, time);
            }

        }, "16n");

        Tone.Transport.bpm.value = 138;
        loop.start(0);
        Tone.Transport.start();
        isPlaying = true;
    }

    // -- CONTROLS --
    
    // Slider
    const slider = document.getElementById('intensitySlider');
    const valDisplay = document.getElementById('valDisplay');
    slider.addEventListener('input', (e) => {
        intensity = parseFloat(e.target.value) / 100;
        valDisplay.innerText = e.target.value;
    });

    // Start Button Logic
    document.getElementById('overlay').addEventListener('click', () => {
        if (!isPlaying) {
            initAudio().then(() => {
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('controls').style.display = 'flex';
            }).catch(e => {
                console.error(e);
                alert("Audio failed to start. Try using Chrome or Firefox.");
            });
        }
    });

    // Mute
    const muteBtn = document.getElementById('muteBtn');
    muteBtn.addEventListener('click', () => {
        Tone.Destination.mute = !Tone.Destination.mute;
        muteBtn.innerText = Tone.Destination.mute ? "SOUND ON" : "MUTE AUDIO";
        muteBtn.style.opacity = Tone.Destination.mute ? "0.5" : "1";
    });

</script>
</body>
</html>
